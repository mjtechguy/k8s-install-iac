---
- name: Install RKE2
  shell: |
    curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} sh -s - \
        {% for san in tls_sans.split(',') %} --tls-san {{ san }}{% endfor %}
  register: rke2_install_result
  changed_when: rke2_install_result.rc == 0

- name: Ensure $HOME/.kube directory exists
  file:
    path: "{{ lookup('env', 'HOME') }}/.kube"
    state: directory
    mode: '0700'

- name: Copy kubeconfig to desired location
  copy:
    src: "{{ kubeconfig_path | default('/etc/rancher/rke2/rke2.yaml') }}"
    dest: "{{ lookup('env', 'HOME') }}/.kube/config"
    remote_src: true
    mode: '0600'
  become: true

- name: Update server IP in kubeconfig
  replace:
    path: "{{ lookup('env', 'HOME') }}/.kube/config"
    regexp: '127.0.0.1'
    replace: "{{ tls_sans.split(',')[0] }}"

- name: Sleep for 30 seconds to allow RKE2 to fully initialize
  wait_for:
    timeout: 30
